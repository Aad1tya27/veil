# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
# vim: set ts=2 sw=2 tw=0 fo=cnqoj

version: 1

before:
  hooks:
    - cd packages/caddy && go mod tidy && cd ../..
    - go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

builds:
  - env:
      - CGO_ENABLED=1
    goos:
      - linux
      - windows
      - darwin
    goarch:
      - amd64
      - arm64
    dir: ./packages/caddy
    binary: veil
    hooks:
      pre: make setup
    flags:
      - -tags=netgo
    ldflags:
      - -linkmode=external

nfpms:
  - id: packages
    package_name: veil
    file_name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    vendor: TheFlywheel
    homepage: https://github.com/try-veil/veil
    maintainer: Yash Mittal <yash@techsavvyash.dev>
    description: Veil - Dynamic API Gateway Extension for Caddy
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - git
      - xcaddy
    recommends:
      - caddy

archives:
  - format: tar.gz
    name_template: >-
      {{ .ProjectName }}_{{ .Version }}_
      {{- title .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
    format_overrides:
      - goos: windows
        format: zip
    files:
      - README*
      - LICENSE*

brews:
  - name: veil
    repository:
      owner: try-veil
      name: homebrew-tap
      token: "{{ .Env.HOMEBREW_TAP_TOKEN }}"
    commit_author:
      name: goreleaserbot
      email: bot@goreleaser.com
    homepage: "https://github.com/try-veil/veil"
    description: "Veil - Dynamic API Gateway Extension for Caddy"
    license: "MIT"
    test: |
      system "#{bin}/veil version"
    dependencies:
      - name: caddy
    install: |
      bin.install "veil"

aurs:
  - name: veil-bin
    homepage: "https://github.com/try-veil/veil"
    description: "Veil - Dynamic API Gateway Extension for Caddy"
    maintainers:
      - "Yash Mittal <yash@techsavvyash.dev>"
    license: "MIT"
    private_key: "{{ .Env.AUR_KEY }}"
    git_url: "ssh://aur@aur.archlinux.org/veil-bin.git"
    package: |-
      # bin
      install -Dm755 "./veil" "${pkgdir}/usr/bin/veil"
      # license
      install -Dm644 "./LICENSE" "${pkgdir}/usr/share/licenses/veil/LICENSE"

publishers:
  - name: cloudsmith
    ids:
      - packages
    env:
      - CLOUDSMITH_API_KEY={{ .Env.CLOUDSMITH_API_KEY }}
    cmd: |
      curl -f -X POST "https://upload.cloudsmith.io/try-veil/veil/{{ if eq .Format "deb" }}debian/{{ else if eq .Format "rpm" }}rpm/{{ end }}main/" \
        -H "X-Api-Key: $CLOUDSMITH_API_KEY" \
        -F "package=@{{ .ArtifactPath }}"

release:
  github:
    owner: try-veil
    name: veil
  draft: false
  prerelease: auto
  mode: replace
  header: |
    ## Installation
    
    ### Homebrew (macOS/Linux)
    ```bash
    brew install try-veil/tap/veil
    ```
    
    ### Arch Linux (AUR)
    ```bash
    yay -S veil-bin
    ```
    
    ### Manual Installation
    Download the appropriate package for your system from the assets below.
  footer: |
    ---
    Released by [GoReleaser](https://github.com/goreleaser/goreleaser) on behalf of TheFlywheel.

changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^ci:"
      - Merge pull request
      - Merge branch
